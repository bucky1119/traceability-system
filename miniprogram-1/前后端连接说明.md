# 小程序前后端连接说明

## 概述

本文档说明如何完善小程序前端与后端API的连接，确保所有功能模块正常工作。

## 当前状态

### ✅ 已完成
1. **模拟数据系统** - 完整的模拟数据支持
2. **图片上传功能** - 产品录入页面支持图片上传
3. **筛选功能修复** - 首页和我的产品页面筛选功能正常
4. **产品唯一ID** - 为产品添加了唯一标识
5. **用户界面重设计** - 新的用户中心界面，支持管理员功能
6. **界面优化** - 移除不必要的按钮，优化用户体验

### 🔄 需要完善
1. **真实API连接** - 连接真实后端服务
2. **管理员功能实现** - 完善管理员相关功能
3. **图片上传到服务器** - 实现图片上传到后端
4. **二维码生成** - 连接真实的二维码生成服务

## API接口规范

### 1. 认证相关接口

#### 用户登录
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "123456"
}

Response:
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "username": "admin",
    "role": "admin",
    "tel": "13800138000",
    "enterprise": "绿色农场合作社"
  }
}
```

#### 用户注册
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "zhangsan",
  "password": "123456",
  "tel": "13800138000",
  "roleId": 2,
  "enterpriseId": 1
}

Response:
{
  "success": true,
  "message": "注册成功"
}
```

### 2. 产品相关接口

#### 获取产品列表
```http
GET /api/products?status=qualified&keyword=白菜
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "productId": "P202401001",
      "name": "有机白菜",
      "batch": {
        "id": 1,
        "batchCode": "BT202401001"
      },
      "origin": "山东省寿光市",
      "producerName": "张三",
      "isQualified": true,
      "imageUrl": "https://example.com/images/cabbage.jpg",
      "created_at": "2024-03-16T14:30:00Z"
    }
  ]
}
```

#### 创建产品
```http
POST /api/products
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "有机白菜",
  "batchCode": "BT202401001",
  "origin": "山东省寿光市",
  "plantingDate": "2024-01-15",
  "harvestDate": "2024-03-15",
  "testType": "pesticide",
  "testDate": "2024-03-16",
  "isQualified": true,
  "imageUrl": "https://example.com/images/cabbage.jpg",
  "description": "采用有机种植方式，无农药残留"
}

Response:
{
  "success": true,
  "data": {
    "product": {
      "id": 1,
      "productId": "P202401001"
    },
    "batch": {
      "id": 1,
      "batchCode": "BT202401001"
    }
  }
}
```

#### 获取产品详情
```http
GET /api/products/{id}
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "productId": "P202401001",
    "name": "有机白菜",
    "batch": {
      "id": 1,
      "batchCode": "BT202401001"
    },
    "origin": "山东省寿光市",
    "producer": {
      "id": 1,
      "username": "张三",
      "tel": "13800138000",
      "enterprise": "绿色农场合作社"
    },
    "isQualified": true,
    "imageUrl": "https://example.com/images/cabbage.jpg",
    "created_at": "2024-03-16T14:30:00Z"
  }
}
```

### 3. 二维码相关接口

#### 创建二维码
```http
POST /api/qrcodes
Authorization: Bearer <token>
Content-Type: application/json

{
  "productId": 1,
  "batchId": 1
}

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "qrcodeId": "QR202401001",
    "productId": 1,
    "batchId": 1,
    "generateTime": "2024-03-16T15:00:00Z"
  }
}
```

#### 获取二维码图片
```http
GET /api/qrcodes/preview/{qrcodeId}
Authorization: Bearer <token>

Response: 图片文件
```

#### 下载二维码
```http
GET /api/qrcodes/download/{qrcodeId}
Authorization: Bearer <token>

Response: 图片文件
```

### 4. 溯源相关接口

#### 获取溯源信息
```http
GET /api/qrcodes/trace/{qrcodeId}
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "product": {
      "id": 1,
      "name": "有机白菜",
      "origin": "山东省寿光市",
      "isQualified": true,
      "producer": {
        "id": 1,
        "username": "张三",
        "tel": "13800138000",
        "enterprise": "绿色农场合作社"
      }
    },
    "batch": {
      "id": 1,
      "batchCode": "BT202401001",
      "quantity": 1000,
      "unit": "kg"
    },
    "qrcode": {
      "qrcodeId": "QR202401001",
      "generateTime": "2024-03-16T15:00:00Z",
      "scanCount": 156
    }
  }
}
```

### 5. 管理员接口

#### 获取农户列表
```http
GET /api/admin/farmers
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "username": "张三",
      "tel": "13800138000",
      "enterprise": "绿色农场合作社",
      "productCount": 3
    }
  ]
}
```

#### 为农户录入产品
```http
POST /api/admin/products
Authorization: Bearer <token>
Content-Type: application/json

{
  "farmerId": 1,
  "name": "有机白菜",
  "batchCode": "BT202401001",
  "origin": "山东省寿光市",
  "isQualified": true
}

Response:
{
  "success": true,
  "data": {
    "product": {
      "id": 1,
      "productId": "P202401001"
    }
  }
}
```

#### 导出产品信息
```http
GET /api/admin/products/export?farmerId=1
Authorization: Bearer <token>

Response: Excel文件
```

## 配置修改

### 1. 切换到真实API

修改 `config.js` 文件：
```javascript
// 当前环境
env: 'production', // 改为 production

// 是否使用模拟数据（开发环境可用）
useMockData: false, // 改为 false

// API配置
api: {
  production: {
    baseUrl: 'https://your-api-domain.com/api', // 改为真实API地址
    timeout: 10000
  }
}
```

### 2. 图片上传配置

在 `utils/api.js` 中添加图片上传接口：
```javascript
// 图片上传API
export const uploadAPI = {
  // 上传图片
  uploadImage: (filePath) => {
    return new Promise((resolve, reject) => {
      wx.uploadFile({
        url: `${config.getBaseUrl()}/upload/image`,
        filePath: filePath,
        name: 'image',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        },
        success: (res) => {
          const data = JSON.parse(res.data);
          if (data.success) {
            resolve(data.data);
          } else {
            reject(new Error(data.message));
          }
        },
        fail: reject
      });
    });
  }
};
```

### 3. 错误处理优化

在 `utils/api.js` 中完善错误处理：
```javascript
// 请求封装
const request = (url, options = {}) => {
  return new Promise((resolve, reject) => {
    const token = wx.getStorageSync('token');
    
    wx.request({
      url: `${config.getBaseUrl()}${url}`,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.header
      },
      timeout: config.getTimeout(),
      success: (res) => {
        if (res.statusCode === 200) {
          if (res.data.success) {
            resolve(res.data);
          } else {
            reject(new Error(res.data.message || '请求失败'));
          }
        } else if (res.statusCode === 401) {
          // token过期，跳转到登录页
          wx.removeStorageSync('token');
          wx.removeStorageSync('userInfo');
          wx.showToast({
            title: '登录已过期，请重新登录',
            icon: 'none'
          });
          setTimeout(() => {
            wx.reLaunch({
              url: '/pages/userCenter/userCenter'
            });
          }, 1500);
          reject(new Error('登录已过期'));
        } else {
          reject(new Error(res.data.message || '请求失败'));
        }
      },
      fail: (err) => {
        reject(new Error('网络连接失败'));
      }
    });
  });
};
```

## 测试步骤

### 1. 环境配置
1. 确保后端服务正常运行
2. 修改 `config.js` 中的API地址
3. 设置 `useMockData: false`

### 2. 功能测试
1. **用户登录** - 测试登录功能
2. **产品列表** - 测试产品展示和筛选
3. **产品录入** - 测试产品录入和图片上传
4. **二维码生成** - 测试二维码生成和下载
5. **溯源查询** - 测试扫码溯源功能

### 3. 管理员功能测试
1. **农户管理** - 测试农户列表和产品录入
2. **数据导出** - 测试产品信息导出
3. **系统统计** - 测试统计数据展示

## 常见问题

### Q: 如何切换回模拟数据模式？
A: 修改 `config.js` 中的 `useMockData: true`

### Q: API请求失败怎么办？
A: 检查网络连接、API地址配置、token是否有效

### Q: 图片上传失败？
A: 检查图片大小、格式，确保后端支持文件上传

### Q: 二维码生成失败？
A: 检查后端二维码生成服务是否正常

## 部署建议

1. **HTTPS支持** - 生产环境必须使用HTTPS
2. **域名配置** - 在小程序后台配置服务器域名
3. **图片CDN** - 使用CDN加速图片加载
4. **错误监控** - 添加错误日志和监控
5. **性能优化** - 图片压缩、缓存策略等

## 总结

通过以上配置和修改，小程序将能够：

1. **完整连接后端API** - 所有功能模块正常工作
2. **支持图片上传** - 产品图片可以上传到服务器
3. **管理员功能** - 支持管理员对农户产品的管理
4. **数据导出** - 支持产品信息的导出功能
5. **错误处理** - 完善的错误处理和用户提示

确保在部署前进行充分测试，验证所有功能模块的正常工作。 