# å°ç¨‹åºå‰åç«¯è¿æ¥è¯´æ˜

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å®Œå–„å°ç¨‹åºå‰ç«¯ä¸åç«¯APIçš„è¿æ¥ï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ¨¡å—æ­£å¸¸å·¥ä½œã€‚

## å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ
1. **æ¨¡æ‹Ÿæ•°æ®ç³»ç»Ÿ** - å®Œæ•´çš„æ¨¡æ‹Ÿæ•°æ®æ”¯æŒ
2. **å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½** - äº§å“å½•å…¥é¡µé¢æ”¯æŒå›¾ç‰‡ä¸Šä¼ 
3. **ç­›é€‰åŠŸèƒ½ä¿®å¤** - é¦–é¡µå’Œæˆ‘çš„äº§å“é¡µé¢ç­›é€‰åŠŸèƒ½æ­£å¸¸
4. **äº§å“å”¯ä¸€ID** - ä¸ºäº§å“æ·»åŠ äº†å”¯ä¸€æ ‡è¯†
5. **ç”¨æˆ·ç•Œé¢é‡è®¾è®¡** - æ–°çš„ç”¨æˆ·ä¸­å¿ƒç•Œé¢ï¼Œæ”¯æŒç®¡ç†å‘˜åŠŸèƒ½
6. **ç•Œé¢ä¼˜åŒ–** - ç§»é™¤ä¸å¿…è¦çš„æŒ‰é’®ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

### ğŸ”„ éœ€è¦å®Œå–„
1. **çœŸå®APIè¿æ¥** - è¿æ¥çœŸå®åç«¯æœåŠ¡
2. **ç®¡ç†å‘˜åŠŸèƒ½å®ç°** - å®Œå–„ç®¡ç†å‘˜ç›¸å…³åŠŸèƒ½
3. **å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨** - å®ç°å›¾ç‰‡ä¸Šä¼ åˆ°åç«¯
4. **äºŒç»´ç ç”Ÿæˆ** - è¿æ¥çœŸå®çš„äºŒç»´ç ç”ŸæˆæœåŠ¡

## APIæ¥å£è§„èŒƒ

### 1. è®¤è¯ç›¸å…³æ¥å£

#### ç”¨æˆ·ç™»å½•
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "123456"
}

Response:
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "username": "admin",
    "role": "admin",
    "tel": "13800138000",
    "enterprise": "ç»¿è‰²å†œåœºåˆä½œç¤¾"
  }
}
```

#### ç”¨æˆ·æ³¨å†Œ
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "zhangsan",
  "password": "123456",
  "tel": "13800138000",
  "roleId": 2,
  "enterpriseId": 1
}

Response:
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ"
}
```

### 2. äº§å“ç›¸å…³æ¥å£

#### è·å–äº§å“åˆ—è¡¨
```http
GET /api/products?status=qualified&keyword=ç™½èœ
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "productId": "P202401001",
      "name": "æœ‰æœºç™½èœ",
      "batch": {
        "id": 1,
        "batchCode": "BT202401001"
      },
      "origin": "å±±ä¸œçœå¯¿å…‰å¸‚",
      "producerName": "å¼ ä¸‰",
      "isQualified": true,
      "imageUrl": "https://example.com/images/cabbage.jpg",
      "created_at": "2024-03-16T14:30:00Z"
    }
  ]
}
```

#### åˆ›å»ºäº§å“
```http
POST /api/products
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "æœ‰æœºç™½èœ",
  "batchCode": "BT202401001",
  "origin": "å±±ä¸œçœå¯¿å…‰å¸‚",
  "plantingDate": "2024-01-15",
  "harvestDate": "2024-03-15",
  "testType": "pesticide",
  "testDate": "2024-03-16",
  "isQualified": true,
  "imageUrl": "https://example.com/images/cabbage.jpg",
  "description": "é‡‡ç”¨æœ‰æœºç§æ¤æ–¹å¼ï¼Œæ— å†œè¯æ®‹ç•™"
}

Response:
{
  "success": true,
  "data": {
    "product": {
      "id": 1,
      "productId": "P202401001"
    },
    "batch": {
      "id": 1,
      "batchCode": "BT202401001"
    }
  }
}
```

#### è·å–äº§å“è¯¦æƒ…
```http
GET /api/products/{id}
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "productId": "P202401001",
    "name": "æœ‰æœºç™½èœ",
    "batch": {
      "id": 1,
      "batchCode": "BT202401001"
    },
    "origin": "å±±ä¸œçœå¯¿å…‰å¸‚",
    "producer": {
      "id": 1,
      "username": "å¼ ä¸‰",
      "tel": "13800138000",
      "enterprise": "ç»¿è‰²å†œåœºåˆä½œç¤¾"
    },
    "isQualified": true,
    "imageUrl": "https://example.com/images/cabbage.jpg",
    "created_at": "2024-03-16T14:30:00Z"
  }
}
```

### 3. äºŒç»´ç ç›¸å…³æ¥å£

#### åˆ›å»ºäºŒç»´ç 
```http
POST /api/qrcodes
Authorization: Bearer <token>
Content-Type: application/json

{
  "productId": 1,
  "batchId": 1
}

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "qrcodeId": "QR202401001",
    "productId": 1,
    "batchId": 1,
    "generateTime": "2024-03-16T15:00:00Z"
  }
}
```

#### è·å–äºŒç»´ç å›¾ç‰‡
```http
GET /api/qrcodes/preview/{qrcodeId}
Authorization: Bearer <token>

Response: å›¾ç‰‡æ–‡ä»¶
```

#### ä¸‹è½½äºŒç»´ç 
```http
GET /api/qrcodes/download/{qrcodeId}
Authorization: Bearer <token>

Response: å›¾ç‰‡æ–‡ä»¶
```

### 4. æº¯æºç›¸å…³æ¥å£

#### è·å–æº¯æºä¿¡æ¯
```http
GET /api/qrcodes/trace/{qrcodeId}
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "product": {
      "id": 1,
      "name": "æœ‰æœºç™½èœ",
      "origin": "å±±ä¸œçœå¯¿å…‰å¸‚",
      "isQualified": true,
      "producer": {
        "id": 1,
        "username": "å¼ ä¸‰",
        "tel": "13800138000",
        "enterprise": "ç»¿è‰²å†œåœºåˆä½œç¤¾"
      }
    },
    "batch": {
      "id": 1,
      "batchCode": "BT202401001",
      "quantity": 1000,
      "unit": "kg"
    },
    "qrcode": {
      "qrcodeId": "QR202401001",
      "generateTime": "2024-03-16T15:00:00Z",
      "scanCount": 156
    }
  }
}
```

### 5. ç®¡ç†å‘˜æ¥å£

#### è·å–å†œæˆ·åˆ—è¡¨
```http
GET /api/admin/farmers
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "username": "å¼ ä¸‰",
      "tel": "13800138000",
      "enterprise": "ç»¿è‰²å†œåœºåˆä½œç¤¾",
      "productCount": 3
    }
  ]
}
```

#### ä¸ºå†œæˆ·å½•å…¥äº§å“
```http
POST /api/admin/products
Authorization: Bearer <token>
Content-Type: application/json

{
  "farmerId": 1,
  "name": "æœ‰æœºç™½èœ",
  "batchCode": "BT202401001",
  "origin": "å±±ä¸œçœå¯¿å…‰å¸‚",
  "isQualified": true
}

Response:
{
  "success": true,
  "data": {
    "product": {
      "id": 1,
      "productId": "P202401001"
    }
  }
}
```

#### å¯¼å‡ºäº§å“ä¿¡æ¯
```http
GET /api/admin/products/export?farmerId=1
Authorization: Bearer <token>

Response: Excelæ–‡ä»¶
```

## é…ç½®ä¿®æ”¹

### 1. åˆ‡æ¢åˆ°çœŸå®API

ä¿®æ”¹ `config.js` æ–‡ä»¶ï¼š
```javascript
// å½“å‰ç¯å¢ƒ
env: 'production', // æ”¹ä¸º production

// æ˜¯å¦ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨ï¼‰
useMockData: false, // æ”¹ä¸º false

// APIé…ç½®
api: {
  production: {
    baseUrl: 'https://your-api-domain.com/api', // æ”¹ä¸ºçœŸå®APIåœ°å€
    timeout: 10000
  }
}
```

### 2. å›¾ç‰‡ä¸Šä¼ é…ç½®

åœ¨ `utils/api.js` ä¸­æ·»åŠ å›¾ç‰‡ä¸Šä¼ æ¥å£ï¼š
```javascript
// å›¾ç‰‡ä¸Šä¼ API
export const uploadAPI = {
  // ä¸Šä¼ å›¾ç‰‡
  uploadImage: (filePath) => {
    return new Promise((resolve, reject) => {
      wx.uploadFile({
        url: `${config.getBaseUrl()}/upload/image`,
        filePath: filePath,
        name: 'image',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        },
        success: (res) => {
          const data = JSON.parse(res.data);
          if (data.success) {
            resolve(data.data);
          } else {
            reject(new Error(data.message));
          }
        },
        fail: reject
      });
    });
  }
};
```

### 3. é”™è¯¯å¤„ç†ä¼˜åŒ–

åœ¨ `utils/api.js` ä¸­å®Œå–„é”™è¯¯å¤„ç†ï¼š
```javascript
// è¯·æ±‚å°è£…
const request = (url, options = {}) => {
  return new Promise((resolve, reject) => {
    const token = wx.getStorageSync('token');
    
    wx.request({
      url: `${config.getBaseUrl()}${url}`,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.header
      },
      timeout: config.getTimeout(),
      success: (res) => {
        if (res.statusCode === 200) {
          if (res.data.success) {
            resolve(res.data);
          } else {
            reject(new Error(res.data.message || 'è¯·æ±‚å¤±è´¥'));
          }
        } else if (res.statusCode === 401) {
          // tokenè¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
          wx.removeStorageSync('token');
          wx.removeStorageSync('userInfo');
          wx.showToast({
            title: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
            icon: 'none'
          });
          setTimeout(() => {
            wx.reLaunch({
              url: '/pages/userCenter/userCenter'
            });
          }, 1500);
          reject(new Error('ç™»å½•å·²è¿‡æœŸ'));
        } else {
          reject(new Error(res.data.message || 'è¯·æ±‚å¤±è´¥'));
        }
      },
      fail: (err) => {
        reject(new Error('ç½‘ç»œè¿æ¥å¤±è´¥'));
      }
    });
  });
};
```

## æµ‹è¯•æ­¥éª¤

### 1. ç¯å¢ƒé…ç½®
1. ç¡®ä¿åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
2. ä¿®æ”¹ `config.js` ä¸­çš„APIåœ°å€
3. è®¾ç½® `useMockData: false`

### 2. åŠŸèƒ½æµ‹è¯•
1. **ç”¨æˆ·ç™»å½•** - æµ‹è¯•ç™»å½•åŠŸèƒ½
2. **äº§å“åˆ—è¡¨** - æµ‹è¯•äº§å“å±•ç¤ºå’Œç­›é€‰
3. **äº§å“å½•å…¥** - æµ‹è¯•äº§å“å½•å…¥å’Œå›¾ç‰‡ä¸Šä¼ 
4. **äºŒç»´ç ç”Ÿæˆ** - æµ‹è¯•äºŒç»´ç ç”Ÿæˆå’Œä¸‹è½½
5. **æº¯æºæŸ¥è¯¢** - æµ‹è¯•æ‰«ç æº¯æºåŠŸèƒ½

### 3. ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•
1. **å†œæˆ·ç®¡ç†** - æµ‹è¯•å†œæˆ·åˆ—è¡¨å’Œäº§å“å½•å…¥
2. **æ•°æ®å¯¼å‡º** - æµ‹è¯•äº§å“ä¿¡æ¯å¯¼å‡º
3. **ç³»ç»Ÿç»Ÿè®¡** - æµ‹è¯•ç»Ÿè®¡æ•°æ®å±•ç¤º

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åˆ‡æ¢å›æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼ï¼Ÿ
A: ä¿®æ”¹ `config.js` ä¸­çš„ `useMockData: true`

### Q: APIè¯·æ±‚å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A: æ£€æŸ¥ç½‘ç»œè¿æ¥ã€APIåœ°å€é…ç½®ã€tokenæ˜¯å¦æœ‰æ•ˆ

### Q: å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Ÿ
A: æ£€æŸ¥å›¾ç‰‡å¤§å°ã€æ ¼å¼ï¼Œç¡®ä¿åç«¯æ”¯æŒæ–‡ä»¶ä¸Šä¼ 

### Q: äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Ÿ
A: æ£€æŸ¥åç«¯äºŒç»´ç ç”ŸæˆæœåŠ¡æ˜¯å¦æ­£å¸¸

## éƒ¨ç½²å»ºè®®

1. **HTTPSæ”¯æŒ** - ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
2. **åŸŸåé…ç½®** - åœ¨å°ç¨‹åºåå°é…ç½®æœåŠ¡å™¨åŸŸå
3. **å›¾ç‰‡CDN** - ä½¿ç”¨CDNåŠ é€Ÿå›¾ç‰‡åŠ è½½
4. **é”™è¯¯ç›‘æ§** - æ·»åŠ é”™è¯¯æ—¥å¿—å’Œç›‘æ§
5. **æ€§èƒ½ä¼˜åŒ–** - å›¾ç‰‡å‹ç¼©ã€ç¼“å­˜ç­–ç•¥ç­‰

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šé…ç½®å’Œä¿®æ”¹ï¼Œå°ç¨‹åºå°†èƒ½å¤Ÿï¼š

1. **å®Œæ•´è¿æ¥åç«¯API** - æ‰€æœ‰åŠŸèƒ½æ¨¡å—æ­£å¸¸å·¥ä½œ
2. **æ”¯æŒå›¾ç‰‡ä¸Šä¼ ** - äº§å“å›¾ç‰‡å¯ä»¥ä¸Šä¼ åˆ°æœåŠ¡å™¨
3. **ç®¡ç†å‘˜åŠŸèƒ½** - æ”¯æŒç®¡ç†å‘˜å¯¹å†œæˆ·äº§å“çš„ç®¡ç†
4. **æ•°æ®å¯¼å‡º** - æ”¯æŒäº§å“ä¿¡æ¯çš„å¯¼å‡ºåŠŸèƒ½
5. **é”™è¯¯å¤„ç†** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

ç¡®ä¿åœ¨éƒ¨ç½²å‰è¿›è¡Œå……åˆ†æµ‹è¯•ï¼ŒéªŒè¯æ‰€æœ‰åŠŸèƒ½æ¨¡å—çš„æ­£å¸¸å·¥ä½œã€‚ 