<!--index.wxml-->
<view class="container">
  <!-- æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•çŠ¶æ€ -->
  <view class="mock-status" wx:if="{{mockDataStatus}}">
    <text class="mock-text">{{mockDataStatus}}</text>
  </view>

  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <view class="search-header">
    <view class="search-bar">
      <input 
        class="search-input" 
        placeholder="æœç´¢äº§å“åç§°æˆ–æ‰¹æ¬¡ç¼–å·" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
      <button class="search-btn" bindtap="handleSearch">æœç´¢</button>
    </view>
    
    <view class="scan-section">
      <button class="scan-btn" bindtap="handleScan">
        <text class="scan-icon">ğŸ“±</text>
        <text class="scan-text">æ‰«ç æº¯æº</text>
      </button>
    </view>
  </view>

  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <picker 
      mode="selector" 
      range="{{filterOptions}}" 
      range-key="label"
      value="{{filterIndex}}"
      bindchange="onFilterChange"
    >
      <view class="filter-item">
        <text class="filter-label">{{filterOptions[filterIndex].label}}</text>
        <text class="filter-arrow">â–¼</text>
      </view>
    </picker>
    
    <view class="sort-options">
      <text 
        class="sort-item {{sortBy === 'time' ? 'active' : ''}}" 
        bindtap="handleSort"
        data-sort="time"
      >
        æ—¶é—´
      </text>
      <text 
        class="sort-item {{sortBy === 'name' ? 'active' : ''}}" 
        bindtap="handleSort"
        data-sort="name"
      >
        åç§°
      </text>
    </view>
  </view>

  <!-- äº§å“åˆ—è¡¨ -->
  <view class="product-list" wx:if="{{filteredProducts.length > 0}}">
    <view 
      class="product-card" 
      wx:for="{{filteredProducts}}" 
      wx:key="id"
      bindtap="goToDetail"
      data-id="{{item.id}}"
    >
      <view class="product-image">
        <image 
          src="{{item.imageUrl || '/images/default-product.jpg'}}" 
          mode="aspectFill"
        />
        <view class="product-status {{item.isQualified ? 'qualified' : 'unqualified'}}">
          {{item.isQualified ? 'åˆæ ¼' : 'ä¸åˆæ ¼'}}
        </view>
      </view>
      
      <view class="product-content">
        <text class="product-name">{{item.name}}</text>
        <text class="product-batch">æ‰¹æ¬¡: {{item.batch.batchCode}}</text>
        <text class="product-origin" wx:if="{{item.origin}}">äº§åœ°: {{item.origin}}</text>
        <text class="product-producer">ç”Ÿäº§è€…: {{item.producerName}}</text>
        <text class="product-date">å½•å…¥æ—¶é—´: {{item.created_at}}</text>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{filteredProducts.length === 0 && !loading}}">
    <image src="/images/empty.png" mode="aspectFit" class="empty-image"/>
    <text class="empty-text">æš‚æ— äº§å“æ•°æ®</text>
    <text class="empty-subtext">è¯·å…ˆå½•å…¥äº§å“ä¿¡æ¯</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- æº¯æºä¿¡æ¯å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showTraceModal}}" bindtap="closeTraceModal">
    <view class="modal-content" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">äº§å“æº¯æºä¿¡æ¯</text>
        <text class="modal-close" bindtap="closeTraceModal">Ã—</text>
      </view>
      
      <view class="trace-content" wx:if="{{traceInfo}}">
        <view class="trace-section">
          <text class="section-title">äº§å“ä¿¡æ¯</text>
          <view class="trace-info">
            <text class="info-item">äº§å“åç§°: {{traceInfo.product.name}}</text>
            <text class="info-item">æ‰¹æ¬¡ç¼–å·: {{traceInfo.batch.batchCode}}</text>
            <text class="info-item" wx:if="{{traceInfo.product.origin}}">äº§åœ°: {{traceInfo.product.origin}}</text>
            <text class="info-item">æ£€æµ‹ç»“æœ: {{traceInfo.product.isQualified ? 'åˆæ ¼' : 'ä¸åˆæ ¼'}}</text>
          </view>
        </view>
        
        <view class="trace-section">
          <text class="section-title">ç”Ÿäº§è€…ä¿¡æ¯</text>
          <view class="trace-info">
            <text class="info-item">ç”Ÿäº§è€…: {{traceInfo.product.producer.username}}</text>
            <text class="info-item" wx:if="{{traceInfo.product.producer.tel}}">è”ç³»ç”µè¯: {{traceInfo.product.producer.tel}}</text>
            <text class="info-item" wx:if="{{traceInfo.product.producer.enterprise}}">æ‰€å±ä¼ä¸š: {{traceInfo.product.producer.enterprise}}</text>
          </view>
        </view>
        
        <view class="trace-section">
          <text class="section-title">ç§æ¤ä¿¡æ¯</text>
          <view class="trace-info">
            <text class="info-item" wx:if="{{traceInfo.product.plantingDate}}">ç§æ¤æ—¥æœŸ: {{traceInfo.product.plantingDate}}</text>
            <text class="info-item" wx:if="{{traceInfo.product.harvestDate}}">æ”¶è·æ—¥æœŸ: {{traceInfo.product.harvestDate}}</text>
          </view>
        </view>
        
        <view class="trace-section">
          <text class="section-title">æ£€æµ‹ä¿¡æ¯</text>
          <view class="trace-info">
            <text class="info-item" wx:if="{{traceInfo.product.testType}}">æ£€æµ‹ç±»å‹: {{traceInfo.product.testType}}</text>
            <text class="info-item" wx:if="{{traceInfo.product.testDate}}">æ£€æµ‹æ—¥æœŸ: {{traceInfo.product.testDate}}</text>
          </view>
        </view>
        
        <view class="trace-section">
          <text class="section-title">äºŒç»´ç ä¿¡æ¯</text>
          <view class="trace-info">
            <text class="info-item">äºŒç»´ç ID: {{traceInfo.qrcode.qrcodeId}}</text>
            <text class="info-item">ç”Ÿæˆæ—¶é—´: {{traceInfo.qrcode.generateTime}}</text>
            <text class="info-item">æ‰«ç æ¬¡æ•°: {{traceInfo.qrcode.scanCount}}</text>
          </view>
        </view>
      </view>
      
      <view class="modal-actions">
        <button class="btn-secondary" bindtap="closeTraceModal">å…³é—­</button>
        <button class="btn-primary" bindtap="goToDetail" wx:if="{{traceInfo}}">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
      </view>
    </view>
  </view>

  <!-- æ‰«ç ç»“æœå¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showScanResultModal}}" bindtap="closeScanResultModal">
    <view class="modal-content" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">æ‰«ç ç»“æœ</text>
        <text class="modal-close" bindtap="closeScanResultModal">Ã—</text>
      </view>
      
      <view class="scan-result" wx:if="{{scanResult}}">
        <view class="result-success" wx:if="{{scanResult.success}}">
          <text class="result-icon">âœ…</text>
          <text class="result-title">æº¯æºä¿¡æ¯è·å–æˆåŠŸ</text>
          <view class="result-info">
            <text class="info-item">äº§å“: {{scanResult.data.product.name}}</text>
            <text class="info-item">æ‰¹æ¬¡: {{scanResult.data.batch.batchCode}}</text>
            <text class="info-item">ç”Ÿäº§è€…: {{scanResult.data.product.producer.username}}</text>
          </view>
        </view>
        
        <view class="result-error" wx:else>
          <text class="result-icon">âŒ</text>
          <text class="result-title">æº¯æºä¿¡æ¯è·å–å¤±è´¥</text>
          <text class="result-message">{{scanResult.message}}</text>
        </view>
      </view>
      
      <view class="modal-actions">
        <button class="btn-secondary" bindtap="closeScanResultModal">å…³é—­</button>
        <button class="btn-primary" bindtap="viewTraceInfo" wx:if="{{scanResult && scanResult.success}}">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
      </view>
    </view>
  </view>
</view>
