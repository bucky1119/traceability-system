<!--userCenter.wxml-->
<view class="container">
  <!-- 用户信息卡片 -->
  <view class="user-card" wx:if="{{userInfo}}">
    <view class="user-avatar">
      <image src="{{userInfo.avatar || '/images/default-product.jpg'}}" mode="aspectFill"/>
    </view>
    <view class="user-info">
      <text class="user-name">{{userInfo.username}}</text>
      <text class="user-role">{{userInfo.role === 'admin' ? '管理员' : '生产者'}}</text>
      <text class="user-enterprise" wx:if="{{userInfo.enterprise}}">{{userInfo.enterprise}}</text>
    </view>
  </view>

  <!-- 统计数据 -->
  <view class="stats-section" wx:if="{{userInfo}}">
    <view class="stat-card">
      <text class="stat-number">{{stats.productCount}}</text>
      <text class="stat-label">产品数量</text>
    </view>
    <view class="stat-card">
      <text class="stat-number">{{stats.qrcodeCount}}</text>
      <text class="stat-label">二维码</text>
    </view>
    <view class="stat-card">
      <text class="stat-number">{{stats.scanCount}}</text>
      <text class="stat-label">扫码次数</text>
    </view>
  </view>

  <!-- 管理员功能模块 -->
  <view class="admin-section" wx:if="{{userInfo && userInfo.role === 'admin'}}">
    <view class="section-title">管理员功能</view>
    
    <view class="admin-actions">
      <view class="action-item" bindtap="goToFarmerInput">
        <view class="action-icon">👨‍🌾</view>
        <text class="action-text">农户产品录入</text>
        <text class="action-desc">为指定农户录入产品信息</text>
      </view>
      
      <view class="action-item" bindtap="goToProductExport">
        <view class="action-icon">📊</view>
        <text class="action-text">产品信息导出</text>
        <text class="action-desc">导出不同农户的产品信息</text>
      </view>
      
      <view class="action-item" bindtap="goToFarmerManagement">
        <view class="action-icon">👥</view>
        <text class="action-text">农户管理</text>
        <text class="action-desc">管理农户信息和权限</text>
      </view>
      
      <view class="action-item" bindtap="goToSystemStats">
        <view class="action-icon">📈</view>
        <text class="action-text">系统统计</text>
        <text class="action-desc">查看系统整体数据统计</text>
      </view>

      <view class="action-item" bindtap="goToAdminCreate">
        <view class="action-icon">🛡️</view>
        <text class="action-text">创建管理员</text>
        <text class="action-desc">创建新的后台管理员账号</text>
      </view>

      <view class="action-item" bindtap="goToRegistrationCode">
        <view class="action-icon">🔐</view>
        <text class="action-text">设置注册码</text>
        <text class="action-desc">更新生产者注册所需注册码</text>
      </view>
    </view>
  </view>

  <!-- 普通用户功能模块 -->
  <view class="user-section" wx:if="{{userInfo && userInfo.role !== 'admin'}}">
    <view class="section-title">我的功能</view>
    
    <view class="user-actions">
      <view class="action-item" bindtap="goToMyProducts">
        <view class="action-icon">🥬</view>
        <text class="action-text">我的产品</text>
        <text class="action-desc">查看和管理我的产品</text>
      </view>
      
      <view class="action-item" bindtap="goToInput">
        <view class="action-icon">➕</view>
        <text class="action-text">录入产品</text>
        <text class="action-desc">录入新的产品信息</text>
      </view>
      
      <view class="action-item" bindtap="goToQrcodeManagement">
        <view class="action-icon">📱</view>
        <text class="action-text">二维码管理</text>
        <text class="action-desc">管理产品二维码</text>
      </view>
      
      <view class="action-item" bindtap="goToProfile">
        <view class="action-icon">👤</view>
        <text class="action-text">个人信息</text>
        <text class="action-desc">修改个人信息</text>
      </view>
    </view>
  </view>

  <!-- 登录/注册表单 -->
  <view class="auth-section" wx:if="{{!userInfo}}">
    <view class="auth-tabs">
      <text 
        class="tab-item {{!isRegister ? 'active' : ''}}" 
        bindtap="switchToLogin"
      >
        登录
      </text>
      <text 
        class="tab-item {{isRegister ? 'active' : ''}}" 
        bindtap="switchToRegister"
      >
        注册
      </text>
    </view>

    <!-- 登录表单 -->
    <view class="auth-form" wx:if="{{!isRegister}}">
      <view class="form-item" style="display:flex;align-items:center;justify-content:space-between;">
        <text class="label">管理员登录</text>
        <switch checked="{{isAdminLogin}}" bindchange="onAdminLoginSwitch" color="#4caf50" />
      </view>
      <view class="form-item">
        <text class="label">用户名</text>
        <input 
          class="input" 
          placeholder="请输入用户名" 
          value="{{loginForm.username}}"
          bindinput="onLoginInput"
          data-field="username"
        />
      </view>
      
      <view class="form-item">
        <text class="label">密码</text>
        <input 
          class="input" 
          placeholder="请输入密码" 
          password="true"
          value="{{loginForm.password}}"
          bindinput="onLoginInput"
          data-field="password"
        />
      </view>
      
      <button 
        class="btn-primary" 
        bindtap="handleLogin"
        loading="{{loginLoading}}"
      >
        登录
      </button>
    </view>

    <!-- 注册表单（生产者） -->
    <view class="auth-form" wx:if="{{isRegister}}">
      <view class="form-item">
        <text class="label">账号</text>
        <input
          class="input"
          placeholder="请输入登录账号，如 bucky"
          value="{{registerForm.account}}"
          bindinput="onRegisterInput"
          data-field="account"
        />
      </view>

      <view class="form-item">
        <text class="label">姓名</text>
        <input
          class="input"
          placeholder="请输入姓名"
          value="{{registerForm.name}}"
          bindinput="onRegisterInput"
          data-field="name"
        />
      </view>

      <view class="form-item">
        <text class="label">密码</text>
        <input
          class="input"
          placeholder="请输入密码"
          password="true"
          value="{{registerForm.password}}"
          bindinput="onRegisterInput"
          data-field="password"
        />
      </view>

      <view class="form-item">
        <text class="label">确认密码</text>
        <input
          class="input"
          placeholder="请再次输入密码"
          password="true"
          value="{{registerForm.confirmPassword}}"
          bindinput="onRegisterInput"
          data-field="confirmPassword"
        />
      </view>

      <view class="form-item">
        <text class="label">注册码</text>
        <input
          class="input"
          placeholder="请输入管理员提供的注册码"
          value="{{registerForm.registrationCode}}"
          bindinput="onRegisterInput"
          data-field="registrationCode"
        />
      </view>

      <button
        class="btn-primary"
        bindtap="handleRegister"
        loading="{{registerLoading}}"
      >注册</button>
    </view>
  </view>

  <!-- 退出登录按钮 -->
  <view class="logout-section" wx:if="{{userInfo}}">
    <button class="btn-secondary" bindtap="handleLogout">
      退出登录
    </button>
  </view>

  <!-- 个人信息编辑弹窗（生产者） -->
  <view class="modal-overlay" wx:if="{{showProfileModal}}" bindtap="closeProfileModal">
    <view class="modal-content" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">编辑个人信息</text>
        <text class="modal-close" bindtap="closeProfileModal">×</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">用户名</text>
          <input class="input" placeholder="请输入用户名" value="{{profileForm.name}}" bindinput="onProfileInput" data-field="name" />
        </view>
        <view class="form-item">
          <text class="label">联系方式</text>
          <input class="input" placeholder="请输入手机号" value="{{profileForm.phone}}" bindinput="onProfileInput" data-field="phone" />
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn-secondary" bindtap="closeProfileModal">取消</button>
        <button class="btn-primary" bindtap="saveProfile">保存</button>
      </view>
    </view>
  </view>
</view>
