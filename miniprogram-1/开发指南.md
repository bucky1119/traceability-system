# 蔬菜溯源系统小程序开发指南

## 项目概述

这是一个基于微信小程序的蔬菜溯源系统，主要功能包括：
- 产品信息录入和管理
- 二维码生成和扫描
- 溯源信息查询
- 用户注册和登录

## 技术栈

- **前端框架**: 微信小程序原生开发
- **样式语言**: WXSS
- **脚本语言**: JavaScript
- **数据存储**: 微信小程序本地存储 + 云端数据库
- **后端接口**: RESTful API

## 项目结构

```
miniprogram-1/
├── app.js                 # 小程序入口文件
├── app.json              # 小程序配置文件
├── app.wxss              # 全局样式文件
├── config.js             # 配置文件
├── utils/                # 工具函数目录
│   ├── api.js           # API接口封装
│   └── util.js          # 通用工具函数
├── pages/                # 页面目录
│   ├── index/           # 首页
│   ├── detail/          # 产品详情页
│   ├── input/           # 产品录入页
│   ├── myVegetables/    # 我的产品页
│   └── userCenter/      # 用户中心页
└── images/              # 图片资源目录
    ├── home.png         # 首页图标
    ├── add.png          # 录入图标
    ├── my.png           # 我的图标
    ├── user.png         # 用户图标
    └── default-product.png # 默认产品图片
```

## 开发环境配置

### 1. 安装微信开发者工具

下载并安装最新版本的微信开发者工具：
https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

### 2. 导入项目

1. 打开微信开发者工具
2. 选择"导入项目"
3. 选择项目目录 `miniprogram-1`
4. 填写小程序 AppID（如果没有可以选择测试号）

### 3. 配置服务器域名

在微信公众平台配置服务器域名白名单：
- request合法域名：`http://localhost:3000`
- uploadFile合法域名：`http://localhost:3000`
- downloadFile合法域名：`http://localhost:3000`

## 配置文件说明

### config.js

主要配置文件，包含：
- API地址配置
- 环境配置
- 主题色彩配置
- 验证规则配置
- 错误码配置

```javascript
// 修改环境配置
const config = {
  env: 'development', // development, test, production
  api: {
    development: {
      baseUrl: 'http://localhost:3000/api'
    }
  }
};
```

### app.json

小程序全局配置：
- 页面路由配置
- TabBar配置
- 窗口样式配置

## API接口规范

### 认证相关

```javascript
// 用户登录
POST /auth/login
{
  "phone": "13800138000",
  "password": "123456"
}

// 用户注册
POST /auth/register
{
  "phone": "13800138000",
  "password": "123456",
  "name": "张三",
  "role": "farmer",
  "enterpriseId": 1
}

// 获取用户信息
GET /users/profile
```

### 产品相关

```javascript
// 获取产品列表
GET /products?page=1&limit=10&keyword=白菜

// 创建产品
POST /products
{
  "name": "白菜",
  "batchCode": "B20240101001",
  "origin": "山东省",
  "plantingDate": "2024-01-01",
  "harvestDate": "2024-03-01",
  "testType": "pesticide",
  "testDate": "2024-03-01",
  "isQualified": true,
  "imageUrl": "https://example.com/image.jpg"
}

// 获取产品详情
GET /products/:id

// 更新产品
PATCH /products/:id

// 删除产品
DELETE /products/:id
```

### 二维码相关

```javascript
// 创建二维码
POST /qrcodes
{
  "productId": 1,
  "content": "产品溯源信息"
}

// 获取二维码列表
GET /qrcodes?productId=1

// 下载二维码图片
GET /qrcodes/download/:id

// 查询溯源信息
GET /qrcodes/trace/:id
```

## 页面开发规范

### 1. 页面结构

每个页面包含以下文件：
- `.js` - 页面逻辑
- `.wxml` - 页面结构
- `.wxss` - 页面样式
- `.json` - 页面配置

### 2. 页面生命周期

```javascript
Page({
  data: {
    // 页面数据
  },

  onLoad(options) {
    // 页面加载时执行
  },

  onShow() {
    // 页面显示时执行
  },

  onHide() {
    // 页面隐藏时执行
  },

  onUnload() {
    // 页面卸载时执行
  }
});
```

### 3. 数据绑定

```xml
<!-- WXML -->
<view class="container">
  <text>{{title}}</text>
  <button bindtap="handleClick">点击</button>
</view>
```

```javascript
// JS
Page({
  data: {
    title: '页面标题'
  },

  handleClick() {
    this.setData({
      title: '新标题'
    });
  }
});
```

### 4. 事件处理

```javascript
// 点击事件
handleClick(e) {
  const { id } = e.currentTarget.dataset;
  console.log('点击了元素:', id);
},

// 输入事件
handleInput(e) {
  const { value } = e.detail;
  this.setData({
    inputValue: value
  });
},

// 表单提交
handleSubmit(e) {
  const { formData } = e.detail;
  console.log('表单数据:', formData);
}
```

## 样式开发规范

### 1. 全局样式

在 `app.wxss` 中定义全局样式：

```css
/* 主题色彩 */
:root {
  --primary-color: #667eea;
  --success-color: #52c41a;
  --error-color: #ff4d4f;
}

/* 通用样式 */
.container {
  padding: 20rpx;
}

.btn {
  border-radius: 8rpx;
  padding: 20rpx 32rpx;
}
```

### 2. 页面样式

在页面 `.wxss` 文件中定义页面特定样式：

```css
/* 页面容器 */
.page-container {
  background: #f5f5f5;
  min-height: 100vh;
}

/* 卡片样式 */
.card {
  background: #fff;
  border-radius: 12rpx;
  padding: 24rpx;
  margin-bottom: 20rpx;
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.1);
}
```

### 3. 响应式设计

```css
/* 移动端适配 */
@media (max-width: 750rpx) {
  .container {
    padding: 16rpx;
  }
  
  .card {
    padding: 20rpx;
  }
}
```

## 工具函数使用

### 1. API调用

```javascript
import { productAPI } from '../../utils/api.js';

// 获取产品列表
const products = await productAPI.getProducts();

// 创建产品
const result = await productAPI.createProduct({
  name: '白菜',
  batchCode: 'B20240101001'
});
```

### 2. 工具函数

```javascript
import { formatDate, validatePhone } from '../../utils/util.js';

// 格式化日期
const date = formatDate(new Date());

// 验证手机号
const isValid = validatePhone('13800138000');
```

## 错误处理

### 1. 网络错误处理

```javascript
try {
  const data = await api.getData();
} catch (error) {
  console.error('请求失败:', error);
  wx.showToast({
    title: '网络错误，请重试',
    icon: 'none'
  });
}
```

### 2. 表单验证

```javascript
// 验证产品名称
validateProductName(name) {
  if (!name || name.length < 2) {
    wx.showToast({
      title: '产品名称至少2个字符',
      icon: 'none'
    });
    return false;
  }
  return true;
}
```

## 性能优化

### 1. 图片优化

```javascript
// 压缩图片
const compressedImage = await compressImage(imagePath, 0.8);

// 懒加载
<image lazy-load src="{{imageUrl}}" />
```

### 2. 数据缓存

```javascript
// 缓存数据
wx.setStorageSync('products', products);

// 读取缓存
const products = wx.getStorageSync('products');
```

### 3. 防抖节流

```javascript
import { debounce, throttle } from '../../utils/util.js';

// 防抖搜索
const debouncedSearch = debounce(this.handleSearch, 500);

// 节流滚动
const throttledScroll = throttle(this.handleScroll, 100);
```

## 调试技巧

### 1. 控制台调试

```javascript
// 打印调试信息
console.log('调试信息:', data);

// 打印错误信息
console.error('错误信息:', error);
```

### 2. 网络调试

在微信开发者工具中：
1. 打开"调试器"
2. 选择"Network"标签
3. 查看网络请求详情

### 3. 真机调试

1. 在微信开发者工具中点击"预览"
2. 使用微信扫描二维码
3. 在真机上进行调试

## 发布部署

### 1. 代码审核

1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 提交审核

### 2. 版本发布

1. 审核通过后，在微信公众平台发布
2. 配置生产环境API地址
3. 更新小程序版本

### 3. 监控维护

1. 监控小程序运行状态
2. 收集用户反馈
3. 及时修复问题

## 常见问题

### Q: 扫码功能无法使用？
A: 确保已在微信公众平台配置扫码相关权限。

### Q: 图片上传失败？
A: 检查后端文件上传配置，确保上传目录有写入权限。

### Q: 登录状态丢失？
A: 检查JWT token是否过期，确保token刷新机制正常工作。

### Q: 页面跳转失败？
A: 检查页面路径是否正确，确保页面已在app.json中注册。

## 联系方式

如有问题或建议，请联系开发团队。

---

**注意**：本指南仅供开发参考，实际开发中请根据具体需求进行调整。 