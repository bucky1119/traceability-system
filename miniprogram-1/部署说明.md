# 蔬菜溯源系统小程序部署说明

## 部署前准备

### 1. 环境要求

- **微信开发者工具**: 最新版本
- **Node.js**: 14.0+
- **后端服务**: NestJS + MySQL
- **微信公众平台账号**: 已认证的小程序账号

### 2. 域名配置

在微信公众平台配置以下域名：

#### 开发环境
```
request合法域名: http://localhost:3000
uploadFile合法域名: http://localhost:3000
downloadFile合法域名: http://localhost:3000
```

#### 生产环境
```
request合法域名: https://api.yourdomain.com
uploadFile合法域名: https://api.yourdomain.com
downloadFile合法域名: https://api.yourdomain.com
```

### 3. 小程序配置

在微信公众平台配置以下权限：

- **用户信息**: 获取用户基本信息
- **地理位置**: 获取用户地理位置
- **相机**: 扫码功能
- **相册**: 图片上传功能
- **录音**: 语音输入功能（可选）

## 开发环境部署

### 1. 克隆项目

```bash
git clone https://github.com/example/vegetable-traceability-miniprogram.git
cd vegetable-traceability-miniprogram
```

### 2. 配置开发环境

1. 打开 `config.js` 文件
2. 修改环境配置：

```javascript
const config = {
  env: 'development',
  api: {
    development: {
      baseUrl: 'http://localhost:3000/api',
      timeout: 10000
    }
  }
};
```

### 3. 启动后端服务

```bash
# 进入后端目录
cd ../backend

# 安装依赖
npm install

# 启动开发服务器
npm run start:dev
```

### 4. 导入小程序项目

1. 打开微信开发者工具
2. 选择"导入项目"
3. 选择项目目录 `miniprogram-1`
4. 填写小程序 AppID（开发阶段可使用测试号）

### 5. 配置开发者工具

在微信开发者工具中：

1. **项目设置** → **本地设置**
   - 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

2. **详情** → **本地设置**
   - 勾选"开启调试模式"
   - 勾选"开启自动预览"

## 测试环境部署

### 1. 配置测试环境

修改 `config.js` 文件：

```javascript
const config = {
  env: 'test',
  api: {
    test: {
      baseUrl: 'https://test-api.yourdomain.com/api',
      timeout: 10000
    }
  }
};
```

### 2. 部署后端服务

```bash
# 构建生产版本
npm run build

# 部署到测试服务器
npm run deploy:test
```

### 3. 上传测试版本

1. 在微信开发者工具中点击"上传"
2. 填写版本号：`1.0.0-test`
3. 填写项目备注：`测试版本`
4. 提交上传

### 4. 提交审核

1. 登录微信公众平台
2. 进入"版本管理"
3. 选择测试版本，点击"提交审核"
4. 填写审核信息

## 生产环境部署

### 1. 配置生产环境

修改 `config.js` 文件：

```javascript
const config = {
  env: 'production',
  api: {
    production: {
      baseUrl: 'https://api.yourdomain.com/api',
      timeout: 10000
    }
  }
};
```

### 2. 部署后端服务

```bash
# 构建生产版本
npm run build

# 部署到生产服务器
npm run deploy:prod
```

### 3. 配置HTTPS证书

确保生产环境API服务器配置了有效的HTTPS证书：

```bash
# 使用Let's Encrypt免费证书
sudo certbot --nginx -d api.yourdomain.com
```

### 4. 上传生产版本

1. 在微信开发者工具中点击"上传"
2. 填写版本号：`1.0.0`
3. 填写项目备注：`正式版本`
4. 提交上传

### 5. 发布小程序

1. 登录微信公众平台
2. 进入"版本管理"
3. 选择审核通过的版本
4. 点击"发布"

## 监控和维护

### 1. 性能监控

配置小程序性能监控：

```javascript
// 在app.js中添加性能监控
onLaunch() {
  // 上报启动时间
  wx.reportPerformance(1001, 1000, '启动时间');
  
  // 监控网络请求
  wx.reportMonitor('network_request', 1);
}
```

### 2. 错误监控

配置错误上报：

```javascript
// 在app.js中添加错误监控
onError(msg) {
  console.error('小程序错误:', msg);
  
  // 上报错误信息
  wx.reportMonitor('app_error', 1);
}
```

### 3. 用户行为分析

配置用户行为分析：

```javascript
// 在页面中添加用户行为分析
onShow() {
  // 上报页面访问
  wx.reportAnalytics('page_view', {
    page: 'index'
  });
}
```

## 版本管理

### 1. 版本号规范

使用语义化版本号：

```
主版本号.次版本号.修订号
例如：1.0.0, 1.1.0, 1.1.1
```

### 2. 发布流程

1. **开发阶段**: 在开发环境进行功能开发
2. **测试阶段**: 在测试环境进行功能测试
3. **审核阶段**: 提交微信审核
4. **发布阶段**: 审核通过后发布

### 3. 回滚策略

如果发布后发现问题：

1. 立即回滚到上一个稳定版本
2. 修复问题后重新发布
3. 分析问题原因，避免再次发生

## 安全配置

### 1. API安全

- 使用HTTPS协议
- 配置CORS策略
- 实现请求频率限制
- 添加API密钥验证

### 2. 数据安全

- 敏感数据加密存储
- 实现数据备份策略
- 配置数据访问权限
- 定期安全审计

### 3. 用户隐私

- 遵守用户隐私政策
- 最小化数据收集
- 提供数据删除功能
- 定期清理过期数据

## 常见问题

### Q: 上传失败怎么办？
A: 
1. 检查网络连接
2. 确认微信开发者工具版本
3. 检查项目配置是否正确
4. 尝试重新上传

### Q: 审核被拒怎么办？
A:
1. 查看审核反馈
2. 根据反馈修改代码
3. 重新提交审核
4. 如有疑问可联系微信客服

### Q: 生产环境API无法访问？
A:
1. 检查服务器状态
2. 确认域名配置正确
3. 检查HTTPS证书
4. 查看服务器日志

### Q: 用户反馈问题？
A:
1. 收集用户反馈信息
2. 复现问题场景
3. 定位问题原因
4. 及时修复并发布

## 联系支持

- **技术支持**: tech@yourdomain.com
- **产品反馈**: feedback@yourdomain.com
- **紧急联系**: emergency@yourdomain.com

---

**注意**: 部署前请确保所有配置正确，并在测试环境充分验证后再部署到生产环境。 