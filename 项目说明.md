# 设施蔬菜溯源系统

## 项目概述

设施蔬菜溯源系统是一个完整的农产品溯源解决方案，包含微信小程序（消费者端）、Web管理后台（管理员端）和后端API服务。系统支持二维码生成、扫码查询、农事记录、产品管理等功能。

## 技术栈

### 后端
- **框架**: NestJS (Node.js)
- **数据库**: MySQL + TypeORM
- **认证**: JWT
- **API文档**: Swagger
- **限流**: Throttler

### 微信小程序
- **框架**: 微信原生开发
- **UI**: 自定义样式
- **功能**: 扫码查询、历史记录、产品详情

### Web管理后台
- **框架**: React 18
- **UI库**: Ant Design 5
- **状态管理**: Redux Toolkit
- **路由**: React Router 6
- **图表**: Ant Design Charts
- **HTTP客户端**: Axios

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微信小程序     │    │  Web管理后台     │    │    后端API      │
│  (消费者端)      │    │  (管理员端)      │    │   (NestJS)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │     MySQL       │
                    │   数据库        │
                    └─────────────────┘
```

## 功能模块

### 1. 用户管理
- 用户注册、登录、权限管理
- 角色分类：管理员、生产者、消费者
- 用户状态管理

### 2. 企业管理
- 企业信息管理
- 企业认证状态
- 企业产品关联

### 3. 产品管理
- 产品信息录入
- 产品分类管理
- 产品图片上传
- 产品检测信息

### 4. 批次管理
- 产品批次创建
- 批次追踪
- 批次状态管理

### 5. 二维码管理
- 二维码生成
- 二维码批量生成
- 二维码扫描统计
- 二维码图片导出

### 6. 农事操作记录
- 种植记录
- 施肥记录
- 病虫害防治
- 采收记录

### 7. 环境监测
- 温度记录
- 湿度记录
- 光照记录
- 环境数据分析

### 8. 溯源查询
- 扫码查询产品信息
- 完整溯源链条展示
- 历史记录管理

## 快速开始

### 环境要求
- Node.js 16+
- MySQL 8.0+
- 微信开发者工具

### 1. 克隆项目
```bash
git clone <项目地址>
cd traceability-system
```

### 2. 安装依赖
```bash
# 安装后端依赖
cd backend
npm install

# 安装前端依赖
cd ../web-admin
npm install
```

### 3. 配置数据库
```bash
# 创建数据库
CREATE DATABASE traceability_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 配置环境变量
cd backend
cp .env.example .env
# 编辑.env文件，配置数据库连接信息
```

### 4. 启动服务

#### Windows
```bash
# 双击运行
start-system.bat
```

#### Linux/Mac
```bash
# 给脚本执行权限
chmod +x start-system.sh

# 运行启动脚本
./start-system.sh
```

#### 手动启动
```bash
# 启动后端
cd backend
npm run start:dev

# 启动前端（新终端）
cd web-admin
npm start
```

### 5. 访问系统
- **后端API**: http://localhost:3000
- **Web管理后台**: http://localhost:3001
- **API文档**: http://localhost:3000/api
- **微信小程序**: 在微信开发者工具中打开miniprogram目录

## 默认账号

### 管理员账号
- 用户名: admin
- 密码: admin123
- 角色: 管理员

### 生产者账号
- 用户名: producer1
- 密码: producer123
- 角色: 生产者

### 消费者账号
- 用户名: consumer1
- 密码: consumer123
- 角色: 消费者

## 目录结构

```
traceability-system/
├── backend/                 # 后端服务
│   ├── src/
│   │   ├── modules/        # 业务模块
│   │   ├── common/         # 公共模块
│   │   └── main.ts         # 入口文件
│   ├── database/           # 数据库相关
│   └── package.json
├── miniprogram/            # 微信小程序
│   ├── pages/             # 页面文件
│   ├── images/            # 图片资源
│   ├── app.js             # 小程序入口
│   └── app.json           # 小程序配置
├── web-admin/             # Web管理后台
│   ├── src/
│   │   ├── pages/         # 页面组件
│   │   ├── components/    # 公共组件
│   │   ├── store/         # Redux状态管理
│   │   └── services/      # API服务
│   └── package.json
├── start-system.bat       # Windows启动脚本
├── start-system.sh        # Linux/Mac启动脚本
└── README.md              # 项目说明
```

## API接口

### 认证接口
- `POST /auth/login` - 用户登录
- `POST /auth/register` - 用户注册
- `POST /auth/refresh` - 刷新token

### 用户管理
- `GET /users` - 获取用户列表
- `POST /users` - 创建用户
- `PUT /users/:id` - 更新用户
- `DELETE /users/:id` - 删除用户

### 企业管理
- `GET /enterprises` - 获取企业列表
- `POST /enterprises` - 创建企业
- `PUT /enterprises/:id` - 更新企业
- `DELETE /enterprises/:id` - 删除企业

### 产品管理
- `GET /products` - 获取产品列表
- `POST /products` - 创建产品
- `PUT /products/:id` - 更新产品
- `DELETE /products/:id` - 删除产品

### 二维码管理
- `GET /qrcodes` - 获取二维码列表
- `POST /qrcodes` - 生成二维码
- `POST /qrcodes/batch` - 批量生成二维码
- `GET /qrcodes/trace/:id` - 溯源查询（公开接口）

## 部署说明

### 生产环境部署
1. 配置生产环境变量
2. 构建前端项目
3. 配置Nginx反向代理
4. 使用PM2管理Node.js进程

### Docker部署
```bash
# 构建镜像
docker build -t traceability-system .

# 运行容器
docker run -d -p 3000:3000 traceability-system
```

## 开发指南

### 代码规范
- 使用ESLint进行代码检查
- 使用Prettier进行代码格式化
- 遵循TypeScript规范

### 提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建过程或辅助工具的变动
```

### 分支管理
- `main`: 主分支，用于生产环境
- `develop`: 开发分支
- `feature/*`: 功能分支
- `hotfix/*`: 热修复分支

## 常见问题

### 1. 数据库连接失败
- 检查MySQL服务是否启动
- 检查.env文件中的数据库配置
- 确认数据库用户权限

### 2. 前端启动失败
- 检查Node.js版本
- 删除node_modules重新安装
- 检查端口是否被占用

### 3. 微信小程序无法预览
- 检查微信开发者工具版本
- 确认小程序AppID配置
- 检查网络连接

## 技术支持

如有问题，请通过以下方式联系：
- 邮箱: 

## 许可证

本项目采用 MIT 许可证，详见 LICENSE 文件。 